<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="您的好友魔力叉烧包已上线~_(┐「ε:)_❤"><meta name="keyword" content><link rel="shortcut icon" href="/img/favicon.ico"><title>浅入浅出富文本编辑器 - 魔力叉烧包</title><link rel="canonical" href="http://eleanormao.github.io/2018/12/17/rich-text-editor/"><link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.2/css/bootstrap.min.css"><link rel="stylesheet" href="/css/beantech.min.css"><link rel="stylesheet" href="/css/highlight.css"><link rel="stylesheet" href="/css/widget.css"><link rel="stylesheet" href="/css/rocket.css"><link rel="stylesheet" href="/css/signature.css"><link rel="stylesheet" href="/css/toc.css"><link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><script></script></head><body ontouchstart=""><style type="text/css">header.intro-header{background-image:url(/img/about.svg)}</style><header class="intro-header"><div id="signature"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/tags/javascript" title="javascript">javascript</a></div><h1>浅入浅出富文本编辑器</h1><h2 class="subheading"></h2><span class="meta">Posted by Eleanor Mao on 2018-12-17</span></div></div></div></div></div></header><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">魔力叉烧包! Eleanor Mao</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/archives">ARCHIVES</a></li><li><a href="/about/">About</a></li><li><a href="/tags/">tags</a></li><li><a target="_blank" href="https://github.com/EleanorMao">GITHUB</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){0<$navbar.className.indexOf("in")?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"><p>首先让我们思考一下，如果现在产品需要在页面上提供富文本编辑器应该怎么实现🤔</p><p>一般来说方式有以下几种。</p><ol><li>我们可能会想到借助一些编辑器框架、编辑器组件。比如说是ueditor、tinyMCE、draftjs等等。</li><li>或者，我是一个造轮子资深爱好者，决定自己实现。通过使用HTML自带的属性contenteditable。</li></ol><p>没错，现在市面上流行编辑器的也可以分为这两个种类。</p><p>当然如果你只是想实现一些简单的功能。比如像有人一样，通过@去metion一个用户，通过#加上日志的类型。</p><p>那么也可以使用textarea，然后通过绝对定位去处理文本的高亮，以及待选列表的展示等等。</p><p>但是这也随之带来了一些问题。</p><p>比如在Facebook2016年介绍Draftjs的演讲里，他说Facebook早期也是通过这种方式去metion一个人的。</p><p>首先textarea自带一些小问题——不会随着输入而增高等等。</p><p>但是他们发现就有无法正确定位的bug，redo、undo、复制黏贴破坏了metion。</p><p><a href="https://signavio.github.io/react-mentions/master/" target="_blank" rel="noopener">https://signavio.github.io/react-mentions/master/</a> 可以看一下React-Metion的这个demo，当我们去破坏metion的时候，这个体验就变得不符合预期了</p><p>好，我们现在来介绍一些现在主流的几种编辑器的实现。</p><p><strong>一种，就是基于HTML的contenteditable实现。</strong></p><p>比如说我们刚才提到的ueditor、tinyMCE。</p><p>这个属性兼容性非常优秀。没记错的话从IE5开始浏览器就支持这个属性。它允许用户在普通标签里面编辑富文本的内容。同时还有document.execCommand这个更加优秀的API，可以支持格式化文本。后面还新增了比如events、caret、plaintext-only这样的属性，让你控制编辑器只能输入纯文本等等。 <a href="https://w3c.github.io/editing/contentEditable.html#contenteditable" target="_blank" rel="noopener">https://w3c.github.io/editing/contentEditable.html#contenteditable</a></p><p>不过经过广大开发者多年的实践。我们很难说这个contenteditable是好还是坏。 因为这个坑爹属性在不同浏览器下表现不一致。一个回车，可能出现一个<code>&lt;p&gt;</code>，可能是<code>&lt;div&gt;</code>，也有可能是<code>&lt;br&gt;</code>。</p><blockquote><p><a href="https://www.oschina.net/translate/why-contenteditable-is-terrible?cmp" target="_blank" rel="noopener">https://www.oschina.net/translate/why-contenteditable-is-terrible?cmp</a> <a href="https://medium.com/content-uneditable/contenteditable-the-good-the-bad-and-the-ugly-261a38555e9c" target="_blank" rel="noopener">https://medium.com/content-uneditable/contenteditable-the-good-the-bad-and-the-ugly-261a38555e9c</a></p></blockquote><p>这导致你没有办法把视图抽象成一个模型。另外存储数据的时候也是，因为没有办法抽象，你在存储数据的时候就需要存储一段HTML。之后你可能又要花很多精力去处理安全问题。</p><p>现在我们在做IM的时候就遇到这样的问题，业务爸爸们想要富文本，但是DBA不同意啊，这个字段太长啦！不存不存我们不存！</p><p>OK，假如我们的字段够长，DBA同意你存储HTML string。现在想想如果我们想要他输入的内容符合我们的预期行为该怎么办。比如我们回车就是要p标签。第一个想到的可能是监听onKeyPress事件，如果有回车，就手工插入一个p。<a href="https://codepen.io/eleanormao/pen/QJezvG" target="_blank" rel="noopener">https://codepen.io/eleanormao/pen/QJezvG</a> 然后坑爹了。redo和undo事件被破坏了。</p><p>这个问题在有道云笔记的分享里面也有提到。<a href="https://sq.163yun.com/blog/article/168068797113712640" target="_blank" rel="noopener">https://sq.163yun.com/blog/article/168068797113712640</a> 使用document.execCommand对内容修改时，浏览器内部会对该contenteditable区域维护一个undo/redo栈，使得每一个修改行为可以撤销和重做。如果一旦使用了document.execCommand之外的DOM API修改内容，就会破坏undo/redo栈的连续性，导致撤销和重做出错或失效。</p><p>然后你又需要花费很多事件去处理这个问题。另外因为每个浏览器中行为都不一样，你可能在chrome里面实现了，但在火狐里面就有bug了。之后你可能就因为把项目延期了几个月被公司优化掉了。</p><p>当然contenteditable的开发者做了很多的努力，所以上述的这些优秀的插件，帮我们解决了这些问题。</p><p>但是不得不说如果有朝一日产品需要协同编辑，或者自定义一些类型的节点，那可能又要遭遇天坑了。</p><p>还有作为一个React开发者，我们会发现它不React。因为DOM===State。</p><p><strong>第二种，就是超越了contenteditable。</strong></p><p>利用了contenteditable，但是不依赖contenteditable。它们在内部自定义一套数据模型，与视图对应。做到了数据与视图的分离。让contenteditable变得可控。</p><p>这样类型的编辑器，通常可以通过传入一个schema去做一个定制内容，还有因为他变得可控，解决了contenteditable编辑器不能协同编辑、很难自定义的问题。</p><p>另外因为他其实维护的不是DOM本身，而是一组数据，所以序列化Markdown、存储数据的都变得简单。</p><p>这里我主要介绍Slate。</p><p>它和Draft.js一样，他不能开箱即用，不是一个应用。他是一个可完全定制化的富文本编辑器框架。可以把它看做是一个基于React和Immutable的，可插拔的contenteditable。 它利用了React，不需要再去重新构建一套视图的轮子。利用Immutable实现了不可变的数据模型，这点和Draft.js一样。</p><p>这里介绍一些Slate的几个原则。</p><ol><li>插件是一等公民。它的所有逻辑，都是通过一系列的plugins完成。甚至它的核心代码其实也是一个plugin。它把一系列插件的List叫做插件栈。和express和koa的中间件比较类似。当处理事件和富文本的时候它会依次通过插件去处理请求。</li><li>scheme-less的内核。Slate 的核心逻辑并不对你所编辑的数据结构做任何假设，这意味着你在需要应对复杂场景时不会被编辑器预置的内容所束缚</li><li>嵌套文档模型。一个前端工程师不可能不熟悉DOM结构，所以它设计时，也把数据结构竟可能的镜像DOM结构。 比如document下面是block，还有inline、text、range、selection。很好理解，降低了学习成本。同时嵌套的递归的结构，也可以很好的支持复杂的DOM结构。 比如说表格之类的。还有我们知道自由都是建立在规则的基础上的嘛，所以Slate也为数据结构定义了一些强制性的规则。比如说不能有相邻的Text节点、inline节点下面不能有block节点等等。当你改变内容的时候还会自动强制执行normalizer，使数据结构吻合预期。</li><li>与DOM平行。数据模型是建立在DOM基础上的，即，文档是一个嵌套的树。有selection和ranges。并且暴露了所有标准的事件handlers。这使插入例如表格和引用变得可能。任何你在DOM里面能做的，都可以在Slate里面实现。</li><li>无状态的view和不可变的数据。通过React和Immutable.js。Slate编辑器使用构建了一个无状态的、数据不可变的编辑器。</li><li>直观的变更。这里也可以看到Slate是一个十分注重API表现力的框架。他把所有对富文本的操作都变成对editor对象的命令。并且所有的操作都是链式的。<img src="/2018/12/17/rich-text-editor/image.png"></li><li>可协同编辑的数据模型。</li><li>消除了内核边界。因为用了好多插件~</li></ol><p>我们可以发现，有了M，有了V，其实Slate就是一个C。在看他源码的时候也可以发现他的代码分别放在models、controller文件夹下面。</p><p>Slate提供了React组件slate-react，他暴露出一个Editor组件，不过这个组件其实是他controller editor.js的实例。传入的属性（比如onKeyDown、Schema、巴拉巴拉）其实也是一系列插件，Editor实际上是用来管理这些插件的。</p><p>盗一张图来描述一下Slate的数据流动。讲一下他是专门做到视图的统一的。 他的onChange事件其实是滞后的、异步的，其实改变已经反映在视图上了，然后再传递给的onChange。</p><img src="/2018/12/17/rich-text-editor/image1.png"><hr><ul class="pager"><li class="previous"><a href="/2019/03/29/pixel/" data-toggle="tooltip" data-placement="top" title="像素">&larr; Previous Post</a></li><li class="next"><a href="/2017/09/11/webpack-optimize/" data-toggle="tooltip" data-placement="top" title="webpack打包速度优化">Next Post &rarr;</a></li></ul><div class="comment"><div id="disqus_thread" class="disqus-thread"></div></div></div><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"><section><h5><a href="/tags">FEATURED TAGS</a></h5><div class="tags"><a class="tag" href="/tags/javascript" title="javascript">javascript</a></div></section><hr><h5>FRIENDS</h5><ul class="list-inline"><li><a href="#" target="_blank">No Friend</a></li></ul></div></div></div></article><script type="text/javascript">var disqus_shortname="www-chashaobao-net",disqus_identifier="http://eleanormao.github.io/2018/12/17/rich-text-editor/",disqus_url="http://eleanormao.github.io/2018/12/17/rich-text-editor/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){anchors.options={visible:"hover",placement:"left",icon:"ℬ"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")})</script><style>@media all and (min-width:800px){.anchorjs-link{position:absolute;left:-.75em;font-size:1.1em;margin-top:-.1em}}</style><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a target="_blank" href="https://twitter.com/eleanormao"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="http://weibo.com/1700934972/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo&amp;is_all=1"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-weibo fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://github.com/EleanorMao"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Eleanor Mao 2019<br>Send me <a href="mailto:danningmao@outlook.com" title="Email">Email</a> <span style="display:inline-block;margin:0 5px"><i class="fa fa-envelope"></i> </span>| Theme by <a href="http://huangxuan.me">Hux</a></p></div></div></div></footer><script src="https://cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><script src="https://cdn.bootcss.com/bootstrap/3.3.2/js/bootstrap.min.js"></script><script src="/js/hux-blog.min.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script>var _baId="6b4134eecce4a9849b989a2d36031acf",_hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?"+_baId;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><a id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="/js/toc.js?v=1.0.0" async></script></body></html>